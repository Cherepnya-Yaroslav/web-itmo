# –ó–∞–¥–∞–Ω–∏–µ 4: –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π TCP Chat

## –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ TCP –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ threading –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –±–∞–ª–ª–æ–≤ (100%).

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `socket`
- –î–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `threading`
- –ü—Ä–æ—Ç–æ–∫–æ–ª TCP: 100% –±–∞–ª–ª–æ–≤
- –ü—Ä–æ—Ç–æ–∫–æ–ª UDP: 80% –±–∞–ª–ª–æ–≤

## –§–∞–π–ª—ã

- `chat_server.py` - TCP —Å–µ—Ä–≤–µ—Ä —Å –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —á–∞—Ç–æ–º
- `chat_client.py` - TCP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### 1. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
cd lab1/task4_tcp_chat
python3 chat_server.py
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 12347.

### 2. –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö)

```bash
cd lab1/task4_tcp_chat
python3 chat_client.py
```

–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –Ω–∞ –¥—Ä—É–≥–æ–º –∞–¥—Ä–µ—Å–µ:
```bash
python3 chat_client.py <host> <port>
```

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

**–°–µ—Ä–≤–µ—Ä:**
- –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ threading –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∏–∫–Ω–µ–π–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
- –ö–æ–º–∞–Ω–¥—ã —á–∞—Ç–∞ (/help, /users, /time, /quit)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π

**–ö–ª–∏–µ–Ω—Ç:**
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–º–∞–Ω–¥
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π
- –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Å —ç–º–æ–¥–∑–∏

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

- **–ü—Ä–æ—Ç–æ–∫–æ–ª:** TCP (100% –±–∞–ª–ª–æ–≤)
- **–ü–æ—Ä—Ç:** 12347
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:** socket, threading (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ)
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–∞—è (threading)

## –ö–æ–º–∞–Ω–¥—ã —á–∞—Ç–∞

- `/help` - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
- `/users` - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω
- `/time` - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
- `/quit` - –ø–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞:
```
üöÄ Chat Server –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:12347
–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...
–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
--------------------------------------------------
üì± –ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç ('127.0.0.1', 54321)
üë§ Alice (('127.0.0.1', 54321)) –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è. –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 1
üì± –ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç ('127.0.0.1', 54322)
üë§ Bob (('127.0.0.1', 54322)) –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è. –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 2
üí¨ Alice: –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!
üí¨ Bob: –ü—Ä–∏–≤–µ—Ç, Alice!
```

### –ö–ª–∏–µ–Ω—Ç 1 (Alice):
```
üéØ TCP Chat Client
==============================
üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç-—Å–µ—Ä–≤–µ—Ä—É...
–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º:
> Alice
‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, Alice!
üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: 1
üí¨ –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ! –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
--------------------------------------------------
> –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!
[14:30:15] Alice: –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!
üëã Bob –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É!
[14:30:20] Bob: –ü—Ä–∏–≤–µ—Ç, Alice!
```

### –ö–ª–∏–µ–Ω—Ç 2 (Bob):
```
üéØ TCP Chat Client
==============================
üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç-—Å–µ—Ä–≤–µ—Ä—É...
–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º:
> Bob
‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, Bob!
üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: 2
üí¨ –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ! –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
--------------------------------------------------
> –ü—Ä–∏–≤–µ—Ç, Alice!
[14:30:20] Bob: –ü—Ä–∏–≤–µ—Ç, Alice!
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Ç–∞

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```python
# –ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
while True:
    conn, addr = server_socket.accept()
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    client_thread = threading.Thread(
        target=handle_client,
        args=(conn, addr)
    )
    client_thread.start()
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ:

```python
def handle_client(conn, addr):
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
    nickname = receive_nickname(conn)
    clients[nickname] = conn
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ü–∏–∫–ª–µ
    while True:
        message = conn.recv(1024).decode()
        if message == '/quit':
            break
        # –®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
        broadcast(message, sender=nickname)
    
    # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
    remove_client(nickname)
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üßµ Threading:

- –ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –æ–±—â–∏–º —Å–ø–∏—Å–∫–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (locks) –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–Ω–µ–π–º–æ–≤
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –≤–≤–æ–¥–∞

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

- –ü–æ–¥—Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è—Ö/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è—Ö

## –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:

```python
clients_lock = threading.Lock()

def add_client(nickname, conn):
    with clients_lock:
        clients[nickname] = conn

def broadcast(message, sender):
    with clients_lock:
        for nickname, conn in clients.items():
            if nickname != sender:
                conn.sendall(message.encode())
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ 2-3 –∫–ª–∏–µ–Ω—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–∞–Ω–¥—ã —á–∞—Ç–∞

### –¢–µ—Å—Ç 2: –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º
1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ 5+ –∫–ª–∏–µ–Ω—Ç–æ–≤
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/users`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤

### –¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç—ã–π –Ω–∏–∫–Ω–µ–π–º
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ socket (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ threading (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ sys (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ time (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)

## –û—Ü–µ–Ω–∫–∞

- **TCP –ø—Ä–æ—Ç–æ–∫–æ–ª:** 100% –±–∞–ª–ª–æ–≤
- **Threading:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞
- **–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Python: threading](https://docs.python.org/3/library/threading.html)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Python: socket](https://docs.python.org/3/library/socket.html)
